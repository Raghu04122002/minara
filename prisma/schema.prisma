generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Person {
  id        String   @id @default(uuid())
  firstName String?
  lastName  String?
  email     String?
  phone     String?
  
  // Normalized fields for consistent matching
  normalizedEmail String?
  normalizedPhone String?
  
  familyId  String?
  family    Family?  @relation(fields: [familyId], references: [id])
  
  addressId String?
  address   Address? @relation(fields: [addressId], references: [id])

  transactions Transaction[]
  memberships  FamilyMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@index([phone])
  @@index([lastName])
  @@index([normalizedEmail])
  @@index([normalizedPhone])
}


model Transaction {
  id           String   @id @default(uuid())
  amount       Decimal
  type         String   // ticket, donation, program
  description  String?
  occurredAt   DateTime
  sourceSystem String?
  
  personId     String
  person       Person   @relation(fields: [personId], references: [id])
  
  familyId     String?
  family       Family?  @relation(fields: [familyId], references: [id])
  
  importFileId String?
  importFile   RawImportFile? @relation(fields: [importFileId], references: [id])

  is_flagged   Boolean  @default(false)
  flag_reason  String?
  sourceRowIndex Int?

  createdAt    DateTime @default(now())
}

model RawImportFile {
  id           String   @id @default(uuid())
  filename     String
  rowCount     Int
  sourceSystem String?
  transactions Transaction[]
  createdAt    DateTime @default(now())
}

model Family {
  id        String   @id @default(uuid())
  name      String
  
  // Confidence scoring for auto-householding
  confidenceScore  Int?      // 0-100 percentage
  confidenceReason String?   // e.g., 'email+phone', 'address only'
  
  people    Person[]
  members   FamilyMember[]
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FamilyMember {
  id               String   @id @default(uuid())
  role             String   // HEAD, SPOUSE, CHILD, UNKNOWN
  groupedBy        String   // PHONE, EMAIL, ADDRESS, MANUAL
  manualAssignment Boolean  @default(false) // Phase 1B: true if manually assigned
  
  familyId  String
  family    Family   @relation(fields: [familyId], references: [id])
  
  personId  String
  person    Person   @relation(fields: [personId], references: [id])

  createdAt DateTime @default(now())
  
  @@unique([familyId, personId])
}

model Address {
  id             String   @id @default(uuid())
  line1          String?
  city           String?
  state          String?
  postalCode     String?
  normalizedHash String?  @unique
  
  people         Person[]
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("ADMIN") // SUPER_ADMIN or ADMIN
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Phase 1B: Import job tracking
model ImportJob {
  id              String    @id @default(uuid())
  fileName        String
  status          String    @default("pending") // pending | processing | completed | failed
  rowsTotal       Int       @default(0)
  rowsSuccess     Int       @default(0)
  rowsErrors      Int       @default(0)
  startedAt       DateTime?
  finishedAt      DateTime?
  createdByUserId String?
  summaryStats    Json      @default("{}")
  createdAt       DateTime  @default(now())

  errors          ImportError[]
}

model ImportError {
  id            String   @id @default(uuid())
  importJobId   String
  rowNumber     Int
  rawRowData    Json
  errorCode     String
  errorMessage  String
  fieldNames    String[] @default([])
  createdAt     DateTime @default(now())

  importJob     ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
}
